# 데이터 모델링
- 매핑은 색인될 문서의 데이터 모델링이라 할 수 있음
- 매핑을 설정해 두지 않으면 엘라스틱서치가 자동으로 필드를 생성하고 필드 타입까지 결정함

## 매핑 API 이해하기
- 필드의 속성을 정의할 때 각 필드 속성에는 데이터 타입과 메타데이터가 포함됨
- 색인 과정에서 문서가 어떻게 역색인(Inverted Index)으로 변환되는지를 상세히 정의 가능
- 한번 정의된 필드에 서로 다른 타입의 데이터가 입력된다면 뒤에 입력된 데이터의 색인 생성 실패
- 생성된 매핑의 타입은 변경 불가 (인덱스 재생성해야함)
- 매핑 정보를 설정할 때의 고려사항
    - 문자열을 분석할 것인가?
    - _source에 어떤 필드를 정의할 것인가?
    - 날짜 필드를 가지는 필드는 무엇인가?
    - 매핑에 정의되지 않고 유입되는 필드는 어떻게 처리할 것인가?
   
### 매핑 인덱스 만들기
- 인덱스 생성
    - ```
      PUT 인덱스명
      {
        "setting": {
            ...
        },
        "mappings": {
          "_doc": {
            "properties": {
                "컬럼명": {
                  "type": "keyword"
                },
                "movieNm": {
                  "type": "text",
                  "analyzer": "standard"
                },
                "companies": {
                  "properties": {
                    "companyCd": { "type": "keyword" },
                    "companyNm": { "type": "keyword" }
                  }
                }
            }
          }
        }
      }
      ```
- 인덱스 생성 결과
    - ```
      {
        "acknowleged": true,
        "shard_acknowledged": true,
        "index": "인덱스명"
      }
      ```

### 매핑 확인
- _mapping API를 통해 이미 만들어진 매핑 정보를 확인 가능
- ```
  GET 인덱스명/_mapping
  ```

### 매핑 파라미터
- 색인할 필드의 데이터를 어떻게 저장할지에 대한 다양한 옵션을 제공함
1. analyzer
    - 해당 필드의 데이터를 형태소 분석하겠다는 의미
    - 색인과 검색 시 지정한 분석기로 형태소 분석을 수행
    - text 데이터 타입의 필드는 analyzer 매핑 파라미터를 기본적으로 사용해야 함
    - 별도의 분석기 미지정 시 Standard Analyzer로 형태소 분석
2. normalizer
    - term query 분석기를 사용하기 위해 쓰임
    - keyword 데이터 타입의 경우 원문을 기준으로 문서가 색인되기 때문에 cafe, Cafe, CAFE는 서로 다른 문서로 인식됨
    - 하지만 해당 유형을 normalizer를 통해 분석기에 asciifolding과 같은 필터를 사용하면 같은 데이터로 인식 가능
3. boost
    - 필드에 가중치(Weight)를 부여
    - 가중치에 따라 유사도 점수(_score)가 달라짐
    - boost 설정 시 검색 결과의 노출 순서에 영향을 줌
    - 만약 색인 시점에 boost 설정하게 된다면 재색인을 하지 않는 이상 가중치 변경 불가
    - 가급적이면 검색 시에만 사용하는 것을 권장
    - 최신 엘라스틱서치는 boost 설정을 할 수 없도록 바꿈
4. coerce
    - 색인 시 자동 변환을 허용할지 여부를 설정하는 파라미터
    - 엘라스틱서치는 자동을 "10"을 숫자 10으로 형변환하여 수행해서 정상적`으로 처리한다
    - 하지만 coerce 설정을 미사용으로 하면 색인에 실패할 것임
5. copy_to
    - 사라진 _all 기능 대신 활용 가능 (여러 개의 필드를 하나로 모아 검색 가능함)
    - 매핑 파라미터를 추가한 필드의 값을 지정한 필드로 복사
    - ex) keyword 타입의 필드에 copy_to 매핑 파라미터를 사용해 다른 필드로 값을 복사하면, 복사된 필드에서는 text 타입을 지정해 형태소 분석 가능
6. fielddata
    - 힙 공간에 생성하는 메모리 캐시
    - 메모리 부족 현상과 잦은 GC로 현재는 거의 사용되지 않음
    - 최신버전의 엘라스틱서치는 doc_value라는 새로운 형태의 캐시를 제공하고 있다
    - fielddata를 사용해야하는 경우가 있음
        - text 타입의 필드는 기본적으로 분석기에 의해 형태소 분석이 되기 때문에 집계나 정렬 기능을 수행할 수 없음
        - text 타입의 필드에서 집계나 정렬을 수행하고자 할 때에 한해 fielddata를 사용할 수 있음
        - 그러나 fielddata는 메모리에 생성되는 캐시이기 때문에 최소한만으로 사용해야함
    - 메모리 소모가 크기 때문에 기본적으로 비활성화 되어있음
7. doc_values
    - 엘라스틱서치에서 사용하는 기본 캐시
    - text 타입의 필드를 제외한 모든 필드는 기본적으로 doc_value 캐시를 사용함
    - doc_values를 사용함으로써 힙 사용에 대한 부담을 없애고 운영체제의 파일 시스템 캐시를 통해 디스크에 있는 데이터에 빠르게 접근 가능
    - 필드를 정렬, 집계할 필요가 없고 스크리브에서 필드 값에 액세스할 필요가 없다면 디스크 공간을 절약하기 위해 doc_values를 비활성화할 수 있음
    - 한 번 비활성화된 필드는 인덱스를 재색인하지 않는 이상 변경 불가
8. dynamic
    - 매핑에 필드를 추가할 때 동적으로 생성할지, 생성하지 않을지를 결정함
    - 동정 생성 필드으 처리 방법으로 세 가지가 있음
        - true : 새로 추가되는 필드를 매핑에 추가함
        - false : 새로 추가되는 필드를 무시함. 해당 필드는 색인이 되지 않아 검색할 수는 없지만 _source에 표시됨
        - strict : 새로운 필드가 감지되면 예외가 발생하고 문서 자체가 색인되지 않음. 새로 유입되는 필드는 사용자가 매핑에 명시적으로 추가해야함
9. enabled
    - 검색 결과에는 포함하지만 색인은 하고 싶지 않은 경우 사용
10. format
    - 엘라스틱서치는 날짜/시간을 문자열로 표현
    - 정해진 표현 포맷이 있음
11. ignore_above
    - 필드에 저장되는 문자열이 지정한 크기를 넘어서면 빈 값으로 색인함
    - 중간에 잘리는 게 아니라, 빈 값으로 저장됨을 주의
12. ignore_malformed
    - 엘라스틱서치에서는 잘못된 데이터 타입을 색인하려고 하면 예외가 발생하고 해당 문서 전체가 색인되지 않음
    - 이 매핑 파라미터를 통해 해당 필드만 무시하고 문서 색인 가능
13. index
    - 필드값을 색인할지를 결정함
14. fields
    - 다중 필드(multi_field)를 설정할 수 있는 옵션
    - 필드 안에 또 다른 필드의 정보를 추가할 수 있어 같은 string 값을 각각 다른 분석기로 처리할 수 있다.
15. norms
    - 문서의 _score 값 계싼에 필요한 정규화 인수를 사용할지 여부를 설정
    - _scoure계산이 필요없거나 단순 필터링 용도로 사용하는 필드는 비활성화해서 디스크 공간을 절약할 수 있음
16. null_value
    - 엘라스틱서치는 색인 시 문서에 필드가 없거나 필드의 값이 null이면 색인 시 필드를 생성하지 않음
    - 해당 파라미터를 설정하면 문서의 값이 null이더라도 필드를 생성하고 그에 해당하는 값으로 저장함(null value에 대한 default값 지정가능)
17. position_increment_gap
    - 배열 형태의 데이터를 색인할 때 검색의 정확도를 높이기 위해 사용하는 옵션
    - 필드 데이터 중 단어와 단어 사이의 간격(slop)을 허용할지를 설정함
    - 검색 시 단어와 단어 사이의 간격을 기준으로 일치하는 문서를 찾는 데 필요
    - ex) ["john Abraham", "Lincon Smith"]일 때, "Abraham Lincon"으로 검색하더라도 검색이 가능
18. properties
    - Object 타입이나 중첩(Nested) 타입의 스키마를 정의할 때 사용되는 옵션
19. search_analyzer
    - 일반적으로 색인과 검색 시 같은 분석기를 사용함
    - 그러나 다른 분석기를 사용하고 싶은 경우 해당 옵션을 통해 별도 지정 가능
20. similarity
    - 유사도 알고리즘을 지정
    - 엘라스틱서치에서 미리 정의된 유사도 측정 알고리즘은 다음과 같다
        - BM25 : Okapi BM25 알고리즘. 엘라스틱서치의 기본 유사도 측정 알고리즘
        - classic : TF/IDF 알고리즘. 문서 내 용어의 개수와 전체 용어의 개수를 이용해 유사도 계산
        - boolean : 복잡한 수학적 모델을 사용하지 않고 단순히 boolean 연산으로 유사도 측정
21. store
    - 필드의 값을 저장해 검색 결과에 값을 포함하기 위핸 매핑 파라미터
22. term_vector
    - 분석된 용어의 정보를 포함할지 여부를 결정하는 옵션
    - 다음과 같은 인자가 있음
        - no : 텀벡터를 저장하지 않음
        - yes : 필드와 용어만 저장
        - with_positions : 용어, 용어의 시작과 끝 위치를 저장
        - with_offsets : 용어, 문자 오프셋을 저장
        - with_positions_offsets : 용어, 용어의 시작과 끝 위치, 문자 오프셋을 모두 저장

## 2. 메타 필드

### _index 메타 필드
### _type 메타 필드
### _id 메타 필드
### _uid 메타 필드
### _source 메타 필드
### _all 메타 필드
### _routing 메타 필드

## 3. 필드 데이터 타입

### Keyword 데이터 타입
### Text 데이터 타입
### Array 데이터 타입
### Numeric 데이터 타입
### Date 데이터 타입
### Range 데이터 타입
### Boolean 데이터 타입
### Geo-Point 데이터 타입
### IP 데이터 타입
### Object 데이터 타입
### Nested 데이터 타입

## 4. 엘라스틱서치 분석기

### 텍스트 분석 개요
### 역색인 구조
### 분석기의 구조
### 전처리 필터
### 토크나이저 필터
### 토큰 필터
### 동의어 사전

## 5. Document API 이해하기

### 문서 파라미터
### index API
### Get API
### Delete API
### Delete By Query API
### Update API
### Bulk API
### Reindex API