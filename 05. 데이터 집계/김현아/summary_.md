# 데이터 집계

## 1. 집계
  > 데이터를 그룹화해서 각종 통계 지표를 제공하기 위한 기능이다.

1. 엘라스틱서치와 데이터 분석
   - 실시간에 가까운 속도로 가능한 통계 분석
   - 많은 양의 데이터를 조각내어 관리
   - 문서의 수가 늘어나도 배치 처리보다 실시간에 가깝게 문서 처리 가능

2. 엘라스틱서치가 집계에 사용하는 기술
   > 집계 시의 주의할 점에 대해 알아봄
   - 캐시
     - 데이터의 양이 클수록 집계 시 많은 양의 CPU와 메모리 자원 소모
     - 질의에 응답하는 데에 걸리는 시간 또한 길어짐
     - 이런 문제는 노드의 하드웨어 성능을 높여 해결할 수도 있음 (하지만 막대한 비용이 듬)
     - 가장 현실적이고 비용 효율적인 해겨려책은 '캐시'를 이용하는 것
     - 엘라스틱서치의 '캐시'는 질의 결과를 임시 버퍼(캐시)에 둠
     - 이후 처리해야 하는 같은 질의에 대해 매번 같은 결과를 계산하지 않고 버퍼에 보관된 결과를 반환
     - 캐시를 적용하는 것만으로도 인덱스의 성능을 대폭 향상시킬 수 있음
     - 캐시의 크기는 일반적으로 힙 메모리의 1%를 할당함
     - 캐시가 없는 질의의 경우 성능 향상에 별다른 도움은 되지 않음
     - 캐시 활성화 방법
         ```
         conf 폴더 내 elasticsearch.yml 파일을 아래와 같이 수정
         indices.requests.cache.size: 2%
         ```
     - 캐시의 종류
         - Node query Cache : 노드의 모든 샤드가 공유하는 LRU(Least Recently Used) 캐시
         - Shard request Cache : 샤드에서 수행된 쿼리의 결과를 캐싱함. 샤드의 내용이 변경되면 캐시가 삭제되기 때문에 업데이트가 빈번한 인덱스에서는 오히려 성능 저하를 일으킬 수 있다.
         - Field data Cache : 필드에서 집계 연산을 수행할 때는 모든 필드 값을 메모리에 로드함. 엘라스틱서치의 집계 쿼리는 성능적인 측면에서 비용이 많이 든다.

3. 실습 데이터 살펴보기
   - apache-web-log의 default 스냅샷 복구
   - apache-web-log 인덱스 생성
   - 간단한 집계 쿼리 수행
   
4. Aggregation API 이해하기
   - 4가지 집계 방식
       - 버킷 집계 : 쿼리 결과로 도출된 문서 집합에 대해 특정 기준으로 나눈 후, 나눠진 문서들에 대해 산술 연산을 수행함. 이때 나눠진 문서의 모음이 각 버킷에 해당됨.
       - 메트릭 집계 : 쿼리 결과로 도출된 문서 집합에서 필드의 값을 더하거나 평균을 내는 등의 산술 연산을 수행함
       - 파이프라인 집계 : 다른 집계 또는 관련 메트릭 연산의 결과를 집계함
       - 행렬 집계 : 버킷 대상이 되는 문서의 여러 필드에서 추출한 값으로 행렬 연산을 수행함. 아직 공식적인 집계 연산으로 제공되는 것은 아니므로 사용할 때 주의 필요함
       
   - 집계 구문의 구조
       ```
        GET <인덱스명>/_search
        {
          ["query": {
            … <쿼리 구문> …
          },] # 생략가능
          "size" : 0,
          ,"aggs": {
            "<임의의 집계 이름 1>": {
              "<집계 타입>": {
                … <aggreagation_body> …
                "field": "<필드명>"
              }
            [, "meta" : { [<meta_data_body>] } ]?
            [, "aggregations" : { [<sub_aggregation>] } ]?
            },
            "<임의의 집계 이름 2>": { ... }
          }
        }
       ```
       - "aggregations" 대신 "aggs"로 줄여쓸 수 있다.
       - <집계 이름>은 사용자가 임의의 이름을 지정하면 된다.
       - <집계 타입>에는 집계의 유형을 적는다.
       - meta 필드를 사용하거나 aggregations를 중첩할 수 있다.
       - 중첩 시 같은 레벨(aggregation 2)에 또 다른 집계를 정의할 수 있고, 하위 레벨에도 정의할 수 있다.
       - 단, 같은 레벨에 집계를 정의할 때는 부수적인 성격의 집계만 가능하다.
       - size를 0으로 하면 문서의 결과는 출력하지 않는다.
       
   - 집계 영역 (Aggregation Scope)
        ```
        "<집계_이름>" : {
          "global" : {},
          "aggs": {
            "<집계_이름2>": {
              "<집계_타입>": {
                "field": "<필드명>"
              }
            }
          }
        }
        ```
       - 글로벌 버킷 : 전체 문서를 대상으로 집계를 수행
       - 일반 버킷 : 질의 영역 내에서만 집계를 수행
   
## 2. 메트릭 집계

1. 합산 집계
2. 평균 집계
3. 최솟값 집계
4. 최댓값 집계
5. 개수 집계
6. 통계 집계
7. 확장 통계 집계
8. 카디널리티 집계
9. 백분위 수 집계
10. 백분위 수 랭크 집계
11. 지형 경계 집계
12. 지형 중심 집계

## 3. 버킷 집계

1. 범위 집계
2. 날짜 범위 집계
3. 히스토그램 집계
4. 날짜 히스토그램 집계
5. 텀즈 집계

## 4. 파이프라인 집계

1. 형제 집계
2. 부모 집계

## 5. 근사삾으로 제공되는 집계 연산

1. 집계 연산과 정확도
2. 분산 환경에서 집계 연산의 어려움
